---
title: "Project-II"
output: pdf_document
---

```{r setup, include=FALSE, echo =FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

### Read in Training Data
```{r message=FALSE, warning=FALSE, echo =FALSE}
suppressWarnings(library(knitr)) 
suppressWarnings(library(dplyr))
suppressWarnings(library(ggplot2))
suppressWarnings(library(GGally))
suppressWarnings(library(mice))
suppressWarnings(library(purrr))
suppressWarnings(library(glmnet))
suppressWarnings(library(MASS))
suppressWarnings(library(BAS))
suppressWarnings(library(tidyselect))
suppressWarnings(library(stringr))
```


```{r read-data, echo=FALSE}
set.seed(10)
load("paintings_train.Rdata")
load("paintings_test.Rdata")
```

## Manually Data Cleaning

```{r, echo=FALSE}
## Remove Intuitively Useless Variables
paintings_train_1 = paintings_train %>% 
  dplyr::select(-sale,
                -count,
                -authorstandard,
                -winningbidder,
                -other,
                -Height_in,
                -Width_in,
                -Surface_Rect,
                -Diam_in,
                -Surface_Rnd,
                -material,
                -mat,
                -lands_sc,
                -lands_elem,
                -lands_figs,
                -lands_ment,
                -lot,
                -winningbiddertype,
                -type_intermed) %>% 
  mutate(
    subject = ifelse(str_detect(paintings_train$subject,"Paysages|paysages|Paysage|paysage"), "Paysage",
          ifelse(str_detect(paintings_train$subject,"Saint|Saints|saint|saints"), "Saint",
          ifelse(str_detect(paintings_train$subject,"Portrait|Portraits|portrait|portraits"), "Portrait",
          ifelse(str_detect(paintings_train$subject,"Notre Seigneur|NS|Notre-Seigneur|N.S."), "NS",
          ifelse(str_detect(paintings_train$subject,"Marine|marine|Marines|marines"), "Marine",
          ifelse(str_detect(paintings_train$subject,"Bustes|bustes|Buste|buste"), "Buste", 
          ifelse(str_detect(paintings_train$subject,"Fruits|fruits|Fruit|fruit|Fleurs|flures|Fleur|fleur"), "Fruit$Flower", 
          ifelse(str_detect(paintings_train$subject,"Femmes|Femme|femmes|femme"), "Femme", 
          ifelse(str_detect(paintings_train$subject,"Sujets|sujets|Sujet|sujet"), "Sujet", 
          ifelse(str_detect(paintings_train$subject,"Hommes|Homme|hommes|homme"), "Homme",
          ifelse(str_detect(paintings_train$subject,"Enfants|enfants|Enfant|enfant|L'Enfant"), "Enfants", "other"))))))))))) %>% as.factor(.),
    
    author = ifelse(str_detect(paintings_train$author,
                               "David Teniers|David Tesniers|David T\x8eniers"), "David Teniers", 
         ifelse(str_detect(paintings_train$author,
                           "Francois Boucher|Fran\x8dois Boucher|F. Boucher"), "Francois Boucher", 
         ifelse(str_detect(paintings_train$author,
                           "Philippe Wouvermans|Philippe Wouwermans|d'apr\x8fs P. Wouvermans|Ph. Vouvermans|Philippe Wouermans|Philippe Wouwerman"), "Philippe Wouvermans",
         ifelse(str_detect(paintings_train$author,
                           "Charles de la Fosse|Ch. De la Fosse| Charles de LaFosse|C. la Fosse"), "Charles de la Fosse",
         ifelse(str_detect(paintings_train$author,"French"), "French",
         ifelse(str_detect(paintings_train$author,"Gasparo Van Vitelle"), "Gasparo Van Vitelle",
         ifelse(str_detect(paintings_train$author,"Rosalba Carriera"), "Rosalba Carriera", 
         ifelse(str_detect(paintings_train$author,"Nicolas Poussin|N. Poussin"), "Nicolas Poussin",
         ifelse(str_detect(paintings_train$author,"Gaspard Netscher|G. Netscher"), "Gaspard Netscher",
         ifelse(str_detect(paintings_train$author,"Nicolas Berghem|N. Berghem"), "Nicolas Berghem", "other")))))))))) %>% as.factor(.),
    price = as.integer(price),
    dealer = as.factor(dealer),
    origin_author = as.factor(origin_author),
    origin_cat = as.factor(origin_cat),
    school_pntg = as.factor(school_pntg),
    authorstyle = ifelse(authorstyle %in% c("n/a", ""), 0, 1) %>% as.factor(),
    #winningbiddertype = ifelse(winningbiddertype %in% c("n/a", ""), "X", winningbiddertype) %>% as.factor(),
    endbuyer = ifelse(endbuyer %in% c("n/a", ""), "X", endbuyer) %>% as.factor(),
    materialCat = ifelse(materialCat %in% c("n/a", ""), "other", materialCat) %>% as.factor(),
    Shape = ifelse(Shape %in% c("round", "roude"), "round",
                   ifelse(Shape %in% c("oval", "ovale"), "oval",
                          ifelse(Shape == "squ_rect", "squ_rect", "other"))) %>% as.factor(),
    artistliving = as.factor(artistliving),
    diff_origin = as.factor(diff_origin),
    engraved = as.factor(engraved),
    original = as.factor(original),
    prevcoll = as.factor(prevcoll),
    othartist = as.factor(othartist),
    paired = as.factor(paired),
    figures = as.factor(figures),
    lrgfont = as.factor(lrgfont),
    relig = as.factor(relig),
    landsALL = as.factor(landsALL),
    #lands_sc = as.factor(lands_sc),
    #lands_elem = as.factor(lands_elem),
    #lands_figs = as.factor(lands_figs),
    #lands_ment = as.factor(lands_ment),
    arch = as.factor(arch),
    mytho = as.factor(mytho),
    peasant = as.factor(peasant),
    othgenre = as.factor(othgenre),
    singlefig = as.factor(singlefig),
    portrait = as.factor(portrait),
    still_life = as.factor(still_life),
    discauth = as.factor(discauth),
    history = as.factor(history),
    allegory = as.factor(allegory),
    pastorale = as.factor(pastorale),
    finished = as.factor(finished)
  ) %>%  
  .[,c(8, 1:7, 9:38)]

```

## Package Imputation
```{r message=FALSE, warning=FALSE, echo=FALSE}
micetest = mice::mice(paintings_train_1, printFlag = FALSE)
paintings_train_2 = mice::complete(micetest) %>% 
  mutate(Interm = as.factor(Interm))
```

```{r, echo=FALSE}
paintings_test_1 = paintings_test %>% 
  dplyr::select(-sale,
                -count,
                -authorstandard,
                -winningbidder,
                -other,
                -Height_in,
                -Width_in,
                -Surface_Rect,
                -Diam_in,
                -Surface_Rnd,
                -material,
                -mat,
                -lands_sc,
                -lands_elem,
                -lands_figs,
                -lands_ment,
                -lot,
                -winningbiddertype,
                -type_intermed) %>% 
  mutate(
    subject = ifelse(str_detect(paintings_test$subject,"Paysages|paysages|Paysage|paysage"), "Paysage",
          ifelse(str_detect(paintings_test$subject,"Saint|Saints|saint|saints"), "Saint",
          ifelse(str_detect(paintings_test$subject,"Portrait|Portraits|portrait|portraits"), "Portrait",
          ifelse(str_detect(paintings_test$subject,"Notre Seigneur|NS|Notre-Seigneur|N.S."), "NS",
          ifelse(str_detect(paintings_test$subject,"Marine|marine|Marines|marines"), "Marine",
          ifelse(str_detect(paintings_test$subject,"Bustes|bustes|Buste|buste"), "Buste", 
          ifelse(str_detect(paintings_test$subject,"Fruits|fruits|Fruit|fruit|Fleurs|flures|Fleur|fleur"), "Fruit$Flower", 
          ifelse(str_detect(paintings_test$subject,"Femmes|Femme|femmes|femme"), "Femme", 
          ifelse(str_detect(paintings_test$subject,"Sujets|sujets|Sujet|sujet"), "Sujet", 
          ifelse(str_detect(paintings_test$subject,"Hommes|Homme|hommes|homme"), "Homme",
          ifelse(str_detect(paintings_test$subject,"Enfants|enfants|Enfant|enfant|L'Enfant"), "Enfants", "other"))))))))))) %>% as.factor(.),
    
    author = ifelse(str_detect(paintings_test$author,
                               "David Teniers|David Tesniers|David T\x8eniers"), "David Teniers", 
         ifelse(str_detect(paintings_test$author,
                           "Francois Boucher|Fran\x8dois Boucher|F. Boucher"), "Francois Boucher", 
         ifelse(str_detect(paintings_test$author,
                           "Philippe Wouvermans|Philippe Wouwermans|d'apr\x8fs P. Wouvermans|Ph. Vouvermans|Philippe Wouermans|Philippe Wouwerman"), "Philippe Wouvermans",
         ifelse(str_detect(paintings_test$author,
                           "Charles de la Fosse|Ch. De la Fosse| Charles de LaFosse|C. la Fosse"), "Charles de la Fosse",
         ifelse(str_detect(paintings_test$author,"French"), "French",
         ifelse(str_detect(paintings_test$author,"Gasparo Van Vitelle"), "Gasparo Van Vitelle",
         ifelse(str_detect(paintings_test$author,"Rosalba Carriera"), "Rosalba Carriera", 
         ifelse(str_detect(paintings_test$author,"Nicolas Poussin|N. Poussin"), "Nicolas Poussin",
         ifelse(str_detect(paintings_test$author,"Gaspard Netscher|G. Netscher"), "Gaspard Netscher",
         ifelse(str_detect(paintings_test$author,"Nicolas Berghem|N. Berghem"), "Nicolas Berghem", "other")))))))))) %>% as.factor(.),
    price= as.integer(logprice),
    dealer = as.factor(dealer),
    origin_author = as.factor(origin_author),
    origin_cat = as.factor(origin_cat),
    school_pntg = as.factor(school_pntg),
    authorstyle = ifelse(authorstyle %in% c("n/a", ""), 0, 1) %>% as.factor(),
    #winningbiddertype = ifelse(winningbiddertype %in% c("n/a", "", "EB"), "X", winningbiddertype) %>% as.factor(),
    endbuyer = ifelse(endbuyer %in% c("n/a", ""), "X", endbuyer) %>% as.factor(),
    materialCat = ifelse(materialCat %in% c("n/a", ""), "other", materialCat) %>% as.factor(),
    Shape = ifelse(Shape %in% c("round", "roude"), "round",
                   ifelse(Shape %in% c("oval", "ovale"), "oval",
                          ifelse(Shape == "squ_rect", "squ_rect", "other"))) %>% as.factor(),
    artistliving = as.factor(artistliving),
    diff_origin = as.factor(diff_origin),
    engraved = as.factor(engraved),
    original = as.factor(original),
    prevcoll = as.factor(prevcoll),
    othartist = as.factor(othartist),
    paired = as.factor(paired),
    figures = as.factor(figures),
    lrgfont = as.factor(lrgfont),
    relig = as.factor(relig),
    landsALL = as.factor(landsALL),
    #lands_sc = as.factor(lands_sc),
    #lands_elem = as.factor(lands_elem),
    #lands_figs = as.factor(lands_figs),
    #lands_ment = as.factor(lands_ment),
    arch = as.factor(arch),
    mytho = as.factor(mytho),
    peasant = as.factor(peasant),
    othgenre = as.factor(othgenre),
    singlefig = as.factor(singlefig),
    portrait = as.factor(portrait),
    still_life = as.factor(still_life),
    discauth = as.factor(discauth),
    history = as.factor(history),
    allegory = as.factor(allegory),
    pastorale = as.factor(pastorale),
    finished = as.factor(finished)
  ) %>%  
  .[,c(8, 1:7, 9:38)]

```

## Package Imputation
```{r message=FALSE, warning=FALSE, echo=FALSE}
micetest = mice::mice(paintings_test_1, printFlag = FALSE)
paintings_test_2 = mice::complete(micetest) %>% 
  mutate(Interm = as.factor(Interm))
```

###############################################################
############## Modeling  ######################################
###############################################################

## 1. Improve Linear regression

```{r}
## BMA Variable selection

## JZS prior
bma1 = bas.lm(logprice~ ., 
             data=paintings_train_2, 
             method="MCMC", 
             prior = "JZS",
             modelprior=uniform(),
             MCMC.iterations=100000, 
             thin = 10,
             n.models = 15000,
             force.heredity=TRUE)
BPM1 = predict(bma1, estimator = "BPM")

## g-prior
bma2 = bas.lm(logprice~ ., 
             data=paintings_train_2, 
             alpha = nrow(paintings_train_2),
             prior = "g-prior",
             modelprior=uniform(),
             method = "MCMC",
             n.models = 15000)

BPM2 = predict(bma2, estimator = "BPM")

variable.names(BPM1)
variable.names(BPM2)
```


```{r}
## OLS
ols = lm(logprice ~ (dealer + school_pntg + diff_origin + artistliving + endbuyer + authorstyle + 
                       Interm + Shape + Surface + engraved + prevcoll + paired + finished + lrgfont 
                     + portrait + discauth + still_life + year + author + subject)^2, 
         data = paintings_train_2)

summary(ols)
n = nrow(paintings_train_2)
BIC = step(ols, k = log(n))
```


```{r}
ols.2 = lm(logprice ~ Shape + school_pntg + author + subject + year*author + year*dealer + year*subject + year*artistliving + dealer*Interm + dealer*Surface + dealer*paired + dealer*finished + diff_origin*Surface + diff_origin*portrait + artistliving*endbuyer + Interm*Surface + Interm*lrgfont + Surface*lrgfont + Surface*still_life + Surface*discauth + prevcoll*finished + paired*lrgfont + paired*discauth + diff_origin*authorstyle + diff_origin*still_life + finished*discauth + lrgfont*discauth + artistliving*finished + Interm*portrait + dealer*artistliving + authorstyle*prevcoll, data = paintings_train_2)

summary(ols.2)

test = lm(logprice ~ author*Shape + author*school_pntg + year*author + author*subject + author*dealer + author*Interm + author*Surface + author*paired + author*finished + author*diff_origin + author*portrait + author*artistliving + author*endbuyer + author*lrgfont + author*still_life + author*discauth + author*prevcoll + author*authorstyle, data = paintings_train_2)
summary(test)
```

## Negative Binomial
```{r}

```


## RF
```{r}
library(randomForest)
rf = randomForest(logprice ~ .,
                       data = paintings_train_2, 
                       importance = TRUE)
print(rf)
```

## boosting
```{r}
library(gbm)
boosting = gbm(logprice ~.,
               data = paintings_train_2,
               distribution = "gaussian",
               n.trees = 5000,
               interaction.depth = 4)
```

## BART
```{r}
library(BART)
X = model.matrix(logprice ~., 
                 data = paintings_train_2)[,-1]
bart = pbart(x.train = X,
             y.train = paintings_train_2$logprice,
             printevery = 1000)

```


```{r}
predictions = as.data.frame(
  exp(predict(ols.2, 
              newdata=paintings_test_2,
              interval = "pred")))

save(predictions, file="predict-test.Rdata")
```

